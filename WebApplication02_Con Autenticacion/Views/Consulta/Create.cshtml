@model WebApplication02_Con_Autenticacion.Models.consultas

@{
    ViewBag.Title = "Registrar Consulta Médica";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<main class="container my-5 veris-crear-container">
    <h2 class="veris-crear-title">Registrar Nueva Consulta</h2>
    <p class="veris-crear-subtitle">
        Complete la información para registrar una nueva consulta médica.
    </p>
    <hr class="veris-crear-divider" />

    @* Mostrar mensajes de error *@
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* Formulario de selección de médico, paciente y fecha *@
    @using (Html.BeginForm("Create", "Consulta", FormMethod.Get, new { @class = "form-horizontal veris-crear-form" }))
    {
        <!-- Médico -->
        <div class="form-group row mb-3 veris-crear-group">
            <label class="control-label col-md-3 veris-crear-label">Médico</label>
            <div class="col-md-9 veris-crear-input-col">
                @Html.DropDownList("idMedico", ViewBag.IdMedico as SelectList, "-- Seleccione un médico --",
                    new { @class = "form-control veris-crear-input", onchange = "this.form.submit();" })
            </div>
        </div>

        <!-- Paciente -->
        <div class="form-group row mb-3 veris-crear-group">
            <label class="control-label col-md-3 veris-crear-label">Paciente</label>
            <div class="col-md-9 veris-crear-input-col">
                @Html.DropDownList("idPaciente", ViewBag.IdPaciente as SelectList, "-- Seleccione un paciente --",
                    new { @class = "form-control veris-crear-input" })
            </div>
        </div>

        <!-- Fecha de consulta -->
        <div class="form-group row mb-3 veris-crear-group">
            <label class="control-label col-md-3 veris-crear-label">Fecha de Consulta</label>
            <div class="col-md-9 veris-crear-input-col">
                <input type="date" name="fecha"
                       value="@ViewBag.FechaSeleccionada"
                       min="@DateTime.Now.ToString("yyyy-MM-dd")"
                       max="2030-12-31"
                       class="form-control veris-crear-input"
                       onchange="this.form.submit();" />
                <small class="form-text text-muted">
                    Solo se permiten fechas desde hoy hasta el año 2030.
                </small>
            </div>
        </div>
    }

    @* Mostrar horarios disponibles y formulario de confirmación *@
    @{
        var horarios = ViewBag.Horarios as List<string>;
    }

    @if (horarios != null && horarios.Count > 0)
    {
        <h4 class="mt-4 text-center" style="color: #1a73e8;">Horarios Disponibles</h4>

        using (Html.BeginForm("Create", "Consulta", FormMethod.Post, new { @class = "veris-crear-form" }))
        {
            @Html.AntiForgeryToken()

            @Html.Hidden("IdMedico", Request["idMedico"])
            @Html.Hidden("IdPaciente", Request["idPaciente"])
            @Html.Hidden("FechaConsulta", Request["fecha"])

            <!-- Selección de horario -->
            <div class="form-group row mb-3 veris-crear-group">
                <label class="control-label col-md-3 veris-crear-label">Seleccione Horario</label>
                <div class="col-md-9 veris-crear-input-col">
                    <select class="form-control veris-crear-input" name="HI" required>
                        <option value="">-- Seleccione un horario --</option>
                        @foreach (var h in horarios)
                        {
                            <option value="@h">@h</option>
                        }
                    </select>
                    <small class="form-text text-muted">
                        La consulta tendrá una duración de una hora.
                    </small>
                </div>
            </div>

            <!-- Diagnóstico -->
            <div class="form-group row mb-4 veris-crear-group">
                <label class="control-label col-md-3 veris-crear-label">Diagnóstico</label>
                <div class="col-md-9 veris-crear-input-col">
                    <textarea name="Diagnostico" rows="5" class="form-control veris-crear-input"
                              placeholder="Describa el diagnóstico o hallazgos del paciente..." required
                              maxlength="500"></textarea>
                    <small class="form-text text-muted">
                        Máximo 500 caracteres.
                    </small>
                </div>
            </div>

            <!-- Botones -->
            <div class="form-group row text-center veris-crear-button-group mt-4">
                <div class="col-md-12">
                    <button type="submit" class="btn veris-crear-btn">
                        <i class="bi bi-check-circle me-1"></i> Registrar Consulta
                    </button>
                    @Html.ActionLink("Volver a la lista", "Index", null, new { @class = "btn btn-outline-secondary veris-crear-back ms-2" })
                </div>
            </div>
        }
    }
    else if (Request["idMedico"] != null && Request["fecha"] != null)
    {
        <div class="alert alert-warning mt-4 text-center">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>No hay horarios disponibles</strong> para la fecha seleccionada.
            <br />
            <small>Intente con otra fecha o verifique que la especialidad trabaje ese día.</small>
        </div>

        <div class="text-center mt-3">
            @Html.ActionLink("Volver a la lista", "Index", null, new { @class = "btn btn-outline-secondary" })
        </div>
    }
    else
    {
        <div class="alert alert-info mt-4 text-center">
            <i class="bi bi-info-circle me-2"></i>
            Por favor, seleccione un médico y una fecha para ver los horarios disponibles.
        </div>

        <div class="text-center mt-3">
            @Html.ActionLink("Volver a la lista", "Index", null, new { @class = "btn btn-outline-secondary" })
        </div>
    }
</main>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}